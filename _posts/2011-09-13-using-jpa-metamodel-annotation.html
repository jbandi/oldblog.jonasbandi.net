---
layout: post
title: Using the JPA metamodel annotation processor
date: '2011-09-13T21:39:00.001+02:00'
author: Jonas Bandi
tags:
- object-relational mapping
- quicktip
modified_time: '2011-09-15T22:03:02.581+02:00'
thumbnail: http://lh6.ggpht.com/-u-I4XgJGfMY/Tm-xXrPAPPI/AAAAAAAABDI/NXoLIFrYKFk/s72-c/Screen%252520shot%2525202011-09-05%252520at%2525205.22.59%252520PM.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-5763764290649132593.post-5564863451999976544
blogger_orig_url: http://blog.jonasbandi.net/2011/09/using-jpa-metamodel-annotation.html
---

<p>Some time ago I claimed that the <a href="http://jcp.org/en/jsr/detail?id=317">JPA 2.0</a> metamodel API <a href="http://blog.jonasbandi.net/2009/05/jpa2-potential-to-revolutionize-java.html">has the potential to revolutionize Java development</a>.</p><p>I still think that the concept is very interesting by showing an approach to strongly typed meta programming in Java. However I think it does not have any relevance in real world projects. One reason is that strongly typed JPA criteria queries are very verbose and bring their own accidental complexity compared with JPQL. The other reason is the actual usage of an annotation processor in any build environment is still too complicated.</p><p>In the following I show how to configure the <a href="http://wiki.eclipse.org/UserGuide/JPA/Using_the_Canonical_Model_Generator_(ELUG)">JPA metamodel annotation processor of EclipseLink</a> for different environments. <strong>A working example for this is <a href="https://code.google.com/p/jpaworkshop/source/browse/trunk/exercise/06.3-queries-metamodel/">exercise 6.3</a> in our <a href="https://code.google.com/p/jpaworkshop/">jpaworkshop</a>.</strong></p><p> </p><p><strong style="font-size: 130%;">Maven</strong></p><p>EclipseLink documentation is (once again) lacking, ignoring the reality that Maven is currently the most prominent build environment in the enterprise.</p><p>Fortunately this is well documented <a href="http://agoncal.wordpress.com/2010/05/28/jpa-2-0-criteria-api-with-maven-and-eclipselink/">here</a> and <a href="http://blog.gueck.com/2009/12/generating-jpa-20-criteria-canonical.html">here</a>.</p><p>You need to configure a maven processor plugin in <a href="https://code.google.com/p/jpaworkshop/source/browse/trunk/exercise/06.3-queries-metamodel/pom.xml">the pom</a> that triggers the annotation processor in the <code>generate-sources</code> phase:</p><script src="https://gist.github.com/1201161.js?file=gistfile1.xml"></script><p>There are different maven processor plugins. I am using <a href="http://code.google.com/p/maven-annotation-plugin/">maven-annotation-plugin</a>, an alternative is  the <a href="http://mojo.codehaus.org/apt-maven-plugin/">Apt Maven Plugin</a>.</p><p>Now Maven was easy, lets tackle the IDEs...</p><p> </p><p><strong style="font-size: 130%;">NetBeans</strong></p><p>NetBeans excels in this task. When opening the Maven pom, it automatically recognizes the above configuration with the maven-processor-plugin and configures itself to use the EclipseLink annotation processor: <a href="https://lh3.googleusercontent.com/-9HH-_QsDNf4/TnJYbCf0tlI/AAAAAAAABDk/dPtmUvruZOs/Screen%252520shot%2525202011-09-05%252520at%2525205.22.59%252520PM.png"><img style="display: block; margin-top: 5px; margin-bottom: 5px; margin-left: auto; margin-right: auto;" src="http://lh6.ggpht.com/-u-I4XgJGfMY/Tm-xXrPAPPI/AAAAAAAABDI/NXoLIFrYKFk/Screen%252520shot%2525202011-09-05%252520at%2525205.22.59%252520PM.png?imgmax=800" border="0" alt="" width="315" height="210" /></a> No additional configuration whatsoever needed! Metadata API classes get generated on the fly with each compilation and even with background compilation ... I wish NetBeans was my favorite IDE :-)</p><p> </p><p><strong style="font-size: 130%;">IntelliJ IDEA</strong></p><p>Configuration of an annotation processor is nicely documented in <a href="http://blogs.jetbrains.com/idea/tag/annotation-processing/">this post by JetBrains</a>. <a href="https://lh5.googleusercontent.com/-zCEZuZhBLCg/TnJYcIxmwhI/AAAAAAAABDo/kejAKCFJHTo/s800/Screen%252520shot%2525202011-09-07%252520at%2525208.52.36%252520PM.png"><img style="display: block; margin-left: auto; margin-right: auto;" src="http://lh6.ggpht.com/-Vpze86zbhSs/Tm-xZEumN_I/AAAAAAAABDM/JlyaARL6y6g/Screen%252520shot%2525202011-09-07%252520at%2525208.52.36%252520PM.png?imgmax=800" border="0" alt="Screen shot 2011 09 07 at 8 52 36 PM" width="400" height="244" /></a> The good things:</p><ul><li>annotation processors get picked up from the classpath, you dont have to specify the jar (which is a good thing, since the jar name might change when updating the version)</li><li>In combination with IDEA the EclipseLink annotation processor detects the default META-INF/persistence.xml automatically without explicit configuration.</li></ul><p>The bad thing:</p><ul><li>You need to know the exact full qualified name of the annotation processor class.</li><li>Generation of JPA metadata API classes works only on compilation (or on explicitly triggering annotation processing). It does not work on the fly when editing files, since IDEA does not have real background compilation.</li></ul><p> </p><p><strong style="font-size: 130%;">Eclipse IDE</strong></p><p>One might be tempted to think that configuration should be especially easy since Eclipse IDE and EclipseLink imply some kind of close relation...</p><p>The EclipseLink documentation <a href="http://wiki.eclipse.org/UserGuide/JPA/Using_the_Canonical_Model_Generator_%28ELUG%29#Configuring_and_using_within_Eclipse_Galileo">explains how to configure the annotation processor</a> ... except it does not work:</p><p>In combination with Eclipse the EclipseLink annotation processor does not detect the default META-INF/persistence.xml. You have to configure it manually. This is not documented and not trivial. The problem <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=311020">is reported as bug</a>, <strong>but the bug was closed without fixing the problem!</strong><strong> I wonder how many people gave up on using the metadata API just because of that shortcoming...</strong></p><p>Here is how to configure the EclipseLink annotation processor in Eclipse:</p><p>As described in the documentation you have to include three jars on the factory path of the annotation processing configuration:</p><p><a href="https://lh6.googleusercontent.com/-t_YlxPFqGwQ/TnJYh3tQ50I/AAAAAAAABDs/nohbNoNo72M/s912/Screen%252520shot%2525202011-09-07%252520at%2525209.51.28%252520PM.png"><img style="display: block; margin-left: auto; margin-right: auto;" src="http://lh3.ggpht.com/-IBhbqREwBKo/Tm-xa6FYEPI/AAAAAAAABDU/MXQb4TJ47mY/Screen%252520shot%2525202011-09-07%252520at%2525209.51.28%252520PM.png?imgmax=800" border="0" alt="Screen shot 2011 09 07 at 9 51 28 PM" width="400" height="234" /></a></p><p>This approach is bad from the beginning, since those jars might change their name when you update them and they might not versioned together with your sources (this is the case when using Maven) . The approach of IDEA of locating annotation processors in the classpath by their class name is much better in this regard.</p><p>But as mentioned above, this does not yet work. You get the following error written in the eclipse error log:</p><p><code>The persistence xml file [META-INF/persistence.xml] was not found. NO GENERATION will occur!! Please ensure a persistence xml file is available either from the CLASS_OUTPUT directory [META-INF/persistence.xml]</code></p><p><a href="https://lh4.googleusercontent.com/-jwHSMPohIIY/TnJYm636zOI/AAAAAAAABDw/PPQw38eaVIY/Screen%252520shot%2525202011-09-07%252520at%2525209.47.43%252520PM.png"><img style="display: block; margin-left: auto; margin-right: auto;" src="http://lh4.ggpht.com/-KypWBjViCuo/Tm-xZ_s9uuI/AAAAAAAABDQ/nPExs2xbsts/Screen%252520shot%2525202011-09-07%252520at%2525209.47.43%252520PM.png?imgmax=800" border="0" alt="Screen shot 2011 09 07 at 9 47 43 PM" width="400" height="114" /></a></p><p>The solution is to pass the persistence.xml explicitly to the annotation processor. This is achieved by configuring an annotation processor option. The key is <code>eclipselink.persistencexml</code>. The value is the path to your persistence.xml <em>relative from your CLASS_OUTPUT directory</em>. In case of using Maven, your CLASS_OUTPUT directory is target/classes, so you have to prepend <code style="border: solid 1px silver;">../../</code> to your path to arrive in the project root directory ... <em>not trivial indeed</em> ... <span style="font-size: small;">(note that the path separator might vary on Windows)</span></p><p><a href="https://lh3.googleusercontent.com/-HYMe2hXCwyg/TnJYrNDwY2I/AAAAAAAABD0/3L9kPPh7Qn0/s720/Screen%252520shot%2525202011-09-05%252520at%2525205.03.57%252520PM.png"><img style="display: block; margin-left: auto; margin-right: auto;" src="http://lh5.ggpht.com/-ubMpWK1uPlU/Tm-xbyWS_ZI/AAAAAAAABDY/icEdWULCGb8/Screen%252520shot%2525202011-09-05%252520at%2525205.03.57%252520PM.png?imgmax=800" border="0" alt="Screen shot 2011 09 05 at 5 03 57 PM" width="400" height="300" /></a></p><p>Finally generation of JPA metadata API classes is also working in Eclipse. With the great background compilation of Eclipse it is nicely working on the fly when editing files.</p><div style="align: right; font-size: 10px; clear: right;"><p><a href="http://twitter.com/jbandi"><img style="margin: 0px 0px 0px 0px; border: none;" src="http://www.google.com/s2/favicons?domain=twitter.com" border="0" alt="http://www.google.com/s2/favicons?domain=twitter.com" height="13px" align="left" /> If you like this, follow me on twitter...</a></p></div>